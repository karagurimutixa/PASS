<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location-Based Alert</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding-top: 50px;
            background-color: white;
            transition: background-color 0.3s ease;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 25px;
            font-size: 1.2rem;
            cursor: pointer;
            background-color: #28a745;
            border: none;
            color: white;
            border-radius: 5px;
        }

        button:active {
            background-color: #218838;
        }

        .flashing {
            background-color: white;
            animation: flash 0.1s infinite alternate;
        }

        .red-corners {
            border: 10px solid red;
        }

        #movementStatus {
            margin-top: 20px;
            font-size: 1.5rem;
            color: #555;
        }

        @keyframes flash {
            0% {
                background-color: white;
            }
            50% {
                background-color: red;
            }
            100% {
                background-color: white;
            }
        }

        .red-alert {
            background-color: red;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Get Your Location</h1>
    <button id="getLocationBtn">Allow Location</button>
    <div id="status" style="margin-top: 20px;"></div>
    <div id="movementStatus">Waiting for location...</div>

    <script>
        let lastPosition = null;
        let alertTimer = null;
        let movementTimeout = null;
        let alertTriggered = false;
        let manualAlarmTimer = null;
        let manualAlarmTriggered = false;
        let preAlarmAudio = new Audio('https://www.soundjay.com/button/beep-07.wav'); // Pre-alarm sound (lower volume)
        let mainAlarmAudio = new Audio('https://www.soundjay.com/button/beep-08b.wav'); // Main alarm sound (louder)

        let touchStartTime = null;

        // Request location when button is clicked
        document.getElementById('getLocationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        lastPosition = position;
                        startMovementCheck(position);
                        document.getElementById('status').textContent = 'Location Obtained. Monitoring Movement...';
                        document.getElementById('movementStatus').textContent = 'Monitoring movement...';
                        document.getElementById('getLocationBtn').style.display = 'none'; // Hide the "Allow Location" button
                    },
                    (err) => {
                        console.error('Geolocation Error: ', err);
                        document.getElementById('status').textContent = 'Error getting location!';
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });

        // Start movement monitoring every second
        function startMovementCheck(position) {
            // Check movement every second
            movementTimeout = setInterval(() => {
                navigator.geolocation.getCurrentPosition((newPosition) => {
                    let distance = calculateDistance(position.coords, newPosition.coords);
                    if (distance > 0.01) {
                        // If moved significantly
                        resetAlert();
                        document.getElementById('movementStatus').textContent = 'Device is moving!';
                    } else {
                        // If no significant movement
                        document.getElementById('movementStatus').textContent = 'Device is stationary!';
                    }
                });
            }, 1000); // Check every second
        }

        // Calculate distance between two points (in kilometers)
        function calculateDistance(coords1, coords2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (coords2.latitude - coords1.latitude) * Math.PI / 180;
            const dLon = (coords2.longitude - coords1.longitude) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(coords1.latitude * Math.PI / 180) * Math.cos(coords2.latitude * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        }

        // Trigger the alert if no movement is detected for 20 seconds
        function triggerAlert() {
            if (alertTriggered) return; // Prevent multiple triggers
            alertTriggered = true;

            // Make corners red and turn the background to red
            document.body.classList.add('red-corners');
            document.body.classList.add('red-alert');
            document.getElementById('status').textContent = 'No movement detected. Alarm starting soon!';

            // Start pre-alarm sound at lower volume
            preAlarmAudio.volume = 0.1; // Set low volume for pre-alarm
            preAlarmAudio.loop = true;
            preAlarmAudio.play();

            // Set timer for the main alarm to start after 15 seconds
            setTimeout(() => {
                if (alertTriggered) {
                    // Start main alarm sound (louder)
                    mainAlarmAudio.volume = 1; // Set high volume for main alarm
                    mainAlarmAudio.loop = true;
                    mainAlarmAudio.play();
                }
            }, 15000); // Trigger after 15 seconds of no movement
        }

        // Reset the alert and clear any previous timers
        function resetAlert() {
            clearTimeout(alertTimer);
            alertTriggered = false;
            document.body.classList.remove('red-corners', 'red-alert');
            preAlarmAudio.pause();
            preAlarmAudio.currentTime = 0;
            document.getElementById('status').textContent = 'Device is moving, monitoring again...';
        }

        // Monitor movement and trigger alert if needed
        let movementCheckInterval = setInterval(() => {
            if (lastPosition) {
                // If no movement detected for 20 seconds, trigger the alert
                alertTimer = setTimeout(triggerAlert, 20000); // 20 seconds without movement
            }
        }, 1000); // Check for movement every second

        // Detect manual touch for 5 seconds
        document.body.addEventListener('touchstart', (e) => {
            touchStartTime = Date.now();
        });

        document.body.addEventListener('touchend', (e) => {
            if (touchStartTime && (Date.now() - touchStartTime) >= 5000) {
                triggerManualAlarm();
            }
            touchStartTime = null;
        });

        // Trigger manual alarm
        function triggerManualAlarm() {
            if (manualAlarmTriggered) return; // Prevent multiple triggers
            manualAlarmTriggered = true;
            
            // Start manual alarm
            mainAlarmAudio.volume = 1; // Set high volume for main alarm
            mainAlarmAudio.loop = true;
            mainAlarmAudio.play();

            // Flash the screen
            document.body.classList.add('flashing');
            document.getElementById('status').textContent = 'Manual alarm triggered! Press "Stop Alarm" to stop.';
        }

        // Function to stop alarm and flashing
        function stopAlarm() {
            mainAlarmAudio.pause();
            mainAlarmAudio.currentTime = 0;
            preAlarmAudio.pause();
            preAlarmAudio.currentTime = 0;
            document.body.classList.remove('flashing', 'red-corners', 'red-alert');
            document.getElementById('status').textContent = 'Alert resolved. You are safe now.';
            manualAlarmTriggered = false;
        }

        // Add a button to stop the alarm
        let stopButton = document.createElement('button');
        stopButton.textContent = 'Stop Alarm';
        stopButton.addEventListener('click', stopAlarm);
        document.body.appendChild(stopButton);
    </script>
</body>
</html>